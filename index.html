<!DOCTYPE html>
<html>

<head>
	<title>Webcam Image Processor</title>
	<style>
		body,
		html {
			margin: 0;
			padding: 0;
			height: 100%;
			display: flex;
			flex-direction: row;
			overflow: hidden;
			/* Prevents scrollbars */
		}

		#leftPanel {
			width: 20%;
			/* Adjust webcam and sent image width here */
			display: flex;
			flex-direction: column;
			justify-content: flex-start;
			/* Align to top */
			padding: 10px;
			box-sizing: border-box;
		}

		#rightPanel {
			width: 80%;
			/* Adjust processed image width here */
			height: 100vh;
			/* Full viewport height */
			display: flex;
			justify-content: center;
			align-items: flex-start;
			/* Align to top */
			padding: 10px;
			box-sizing: border-box;
			overflow: hidden;
			/* Prevents scrollbars */
		}

		#webcam,
		#lastCaptured {
			width: 100%;
			/* Adjust to set the actual size of webcam and sent image */
			margin-bottom: 10px;
			box-sizing: border-box;
		}

		#result {
			width: auto;
			/* Maintain aspect ratio */
			max-width: 100%;
			/* Limit width to the container */
			max-height: 100vh;
			/* Limit height to the viewport */
			box-sizing: border-box;
		}

		#canvas {
			display: none;
		}
	</style>
</head>

<body>
	<div id="leftPanel">
		<video id="webcam" autoplay></video>
		<img id="previousCaptured" style="max-width: 100%; max-height: 22vh; display: none;">
		<!-- New element for the previous image -->
		<img id="lastCaptured" style="max-width: 100%; max-height: 22vh; display: none;">
	</div>
	<div id="rightPanel">
		<img id="result" style="max-height: 90vh; display: none;">
	</div>
	<canvas id="canvas" style="display: none;"></canvas>

	<script>
		const video = document.getElementById('webcam');
		const canvas = document.getElementById('canvas');
		const resultImage = document.getElementById('result');
		const lastCapturedImage = document.getElementById('lastCaptured');
		const previousCapturedImage = document.getElementById('previousCaptured'); // New variable for the previous image

		let lastImageDataUrl = ''; // Store the last image data URL

		// Backend server configuration
		const serverIP = '78.202.206.149'; // Replace with your server's IP
		const serverPort = '1111'; // Replace with your server's Port
		const serverEndpoint = `http://${serverIP}:${serverPort}/process`;

		// Access the webcam
		navigator.mediaDevices.getUserMedia({ video: true })
			.then(stream => {
				video.srcObject = stream;
				captureAndSendImage(); // Start the cycle
			})
			.catch(err => {
				console.error("Error accessing webcam", err);
			});

		function captureAndSendImage() {
			const context = canvas.getContext('2d');
			canvas.width = video.videoWidth;
			canvas.height = video.videoHeight;
			context.drawImage(video, 0, 0);
			const imageData = canvas.toDataURL('image/png');

			// Update the previous image if we have one
			if (lastImageDataUrl) {
				previousCapturedImage.src = lastImageDataUrl;
				previousCapturedImage.style.display = 'block';
			}

			// Update the last image data URL
			lastImageDataUrl = imageData;

			// Show the last captured image
			lastCapturedImage.src = imageData;
			lastCapturedImage.style.display = 'block';

			fetch(serverEndpoint, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ image: imageData })
			})
				.then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					resultImage.src = data.image;
					resultImage.style.display = 'block';
					captureAndSendImage(); // Take a new picture and send it
				})
				.catch(err => {
					console.error('Error processing image:', err);
					// Optionally retry after a delay
					setTimeout(captureAndSendImage, 1000);
				});
		}
	</script>
</body>

</html>